% ----------------------------------------------------------------------------
% COPYRIGHT
%  Copyright (c) The University of Manchester, 2021.
%  SpiNNaker Project
%  Advanced Processor Technologies Group
%  School of Computer Science
% ----------------------------------------------------------------------------
% AUTHOR
%  lap - luis.plana@manchester.ac.uk
% ----------------------------------------------------------------------------
% DETAILS
%  Created on       : 21 Jun 2021
%  Last modified on : Sat  3 Jul 16:39:12 BST 2021
%  Last modified by : lap
% ----------------------------------------------------------------------------


% --------------------------------------------------------------------------
% define useful variables
% --------------------------------------------------------------------------
\def\myversion{Version 1.0.0}
\def\mydate{03 July 2021}

\def\bcw{5mm}
\def\ncw{45mm}
\def\ocw{10mm}
\def\rcw{10mm}
\def\fcw{45mm}
\def\tblc{green!15}
% --------------------------------------------------------------------------


\documentclass[11pt,a4paper,twoside]{article}
\usepackage{graphicx}
\usepackage{tabularx}
\usepackage[table]{xcolor}
\usepackage[ruled]{algorithm}
\usepackage[noend]{algpseudocode}
\floatname{algorithm}{scheme}
% --------------------------------------------------------------------------

% --------------------------------------------------------------------------
% adjust paper size and margins
% --------------------------------------------------------------------------
\textheight 246mm
\textwidth 154mm
\voffset -7.5mm
\topmargin -8mm
\oddsidemargin 2.7mm
\evensidemargin 2.7mm
\headheight 18.0pt
\headsep 15mm
\raggedbottom
% --------------------------------------------------------------------------

% --------------------------------------------------------------------------
% command to simplify image handling
% --------------------------------------------------------------------------
\newcommand{\image}[5][]
{
\begin{figure}[#2]
   \begin{center}
      \includegraphics[#1]{#3}
      \caption{#5}
      \label{fig:#4}
   \end{center}
\end{figure}
}
% --------------------------------------------------------------------------

\begin{document}

\rule{\linewidth}{2pt}

\begin{center}
	\textbf{
		\Large{SpiNNaker High-Speed Serial Peripheral Interface} \\
		\vspace*{0.5cm}
		\large {\myversion} \\
		\large{\mydate}
	}
\end{center}

\rule{\linewidth}{2pt}

\vspace*{1.0cm}


\section{Interface architecture}

\image[width = \textwidth]{!h}{spin_per_if}{fig:spin_if}
	{SpiNNaker peripheral interface.}


\image[width = \textwidth]{!h}{spif_bd}{fig:spif_bd}
{spif microarchitecture.}


\image[width = 0.9 \textwidth]{!h}{spif_cf}{fig:spif_cf}
{SpiNNaker peripheral interface configuration registers.}

\clearpage
 
\section{spif Configuration}


\subsection{Register Summary}


\begin{center}
	\rowcolors {1}{}{ \tblc }
%		\renewcommand{\arraystretch}{1.2}
	\begin{tabularx}{\textwidth}{| p{34mm} p{13mm} p{21mm} p{7mm} X |}
		\hline
		\textbf{name} & \textbf{offset} & \textbf{offset} (hex) & \textbf{r/w} & \textbf{function} \\%
		\hline
		\hline
		\cellcolor{gray!25}\textbf{reserved} & \cellcolor{gray!25}00      & \cellcolor{gray!25}(0x00)      & \cellcolor{gray!25} & \cellcolor{gray!25}\\%
		\textbf{mp\_key}                     & 01                         & (0x01)                         & w                   & map events to packets \\%
		\cellcolor{gray!25}\textbf{reserved} & \cellcolor{gray!25}02-15   & \cellcolor{gray!25}(0x02-0x0f) & \cellcolor{gray!25} & \cellcolor{gray!25}\\%
		\textbf{ir\_key [15:0]}              & 16-31                      & (0x10-0x1f)                    & w                   & route input packets \\%
		\textbf{ir\_mask [15:0]}             & 32-47                      & (0x20-0x2f)                    & w                   & route input packets \\%
		\textbf{ir\_route [15:0]}            & 48-63                      & (0x30-0x3f)                    & w                   & route input packets \\%
		\textbf{periph\_pkt\_cnt}            & 64                         & (0x40)                         & r/w                 & count periph output pkts\\%
		\textbf{config\_pkt \_cnt}           & 65                         & (0x41)                         & r/w                 & count config packets \\%
		\cellcolor{gray!25}\textbf{reserved} & \cellcolor{gray!25}66-79   & \cellcolor{gray!25}(0x42-0x4f) & \cellcolor{gray!25} & \cellcolor{gray!25}\\%
		\textbf{mp\_fld\_mask [3:0]}         & 80-83                      & (0x50-0x53)                    & w                   & map events to packets \\%
		\cellcolor{gray!25}\textbf{reserved} & \cellcolor{gray!25}84-95   & \cellcolor{gray!25}(0x54-0x5f) & \cellcolor{gray!25} & \cellcolor{gray!25}\\%
		\textbf{mp\_fld\_shift [3:0]}        & 96-99                      & (0x60-0x63)                    & w                   & map events to packets \\%
		\cellcolor{gray!25}\textbf{reserved} & \cellcolor{gray!25}100-127 & \cellcolor{gray!25}(0x67-0x6f) & \cellcolor{gray!25} & \cellcolor{gray!25}\\%
		\hline
	\end{tabularx}
\end{center}


\subsection{Register Details}


\begin{center}
	\rowcolors {1}{}{ \tblc }
	%		\renewcommand{\arraystretch}{1.2}
	\begin{tabularx}{\textwidth}{| p{35mm} p{11mm} p{22mm} X |}
		\hline
		\textbf{name} & \textbf{width}  & \textbf{default} & \textbf{comment} \\%
		\hline
		\hline
		\textbf{mp\_key}                     & 32b  & \ttfamily{0x00000000} & no default value adequate - requires setup \\%
		\textbf{ir\_key [15:0]}              & 32b  & \ttfamily{0x00000000} & match all by default \\%
		\textbf{ir\_mask [15:0]}             & 32b  & \ttfamily{0x00000000} & match all by default \\%
		\textbf{ir\_route [15:0]}            & ~~3b & \ttfamily{0}          & route to (0, 0) by default \\%
		\textbf{periph\_pkt\_cnt}            & 32b  & \ttfamily{0x00000000} & write 0 to reset \\%
		\textbf{config\_pkt \_cnt}           & 32b  & \ttfamily{0x00000000} & write 0 to reset \\%
		\textbf{mp\_fld\_mask [3:0]}         & 32b  & \ttfamily{0x00000000} & mapping off by default \\%
		\textbf{mp\_fld\_shift [3:0]}        & ~~5b & \ttfamily{0}          & limited to right shift only \\%
		\hline
	\end{tabularx}
\end{center}


\clearpage


\section{SpiNNaker FPGA Configuration}


\subsection{Register Summary}


\begin{center}
	\rowcolors {1}{}{ \tblc }
%		\renewcommand{\arraystretch}{1.2}
	\begin{tabularx}{\textwidth}{| p{34mm} p{13mm} p{21mm} p{7mm} X |}
		\hline
		\textbf{name} & \textbf{offset} & \textbf{offset} (hex) & \textbf{r/w} & \textbf{function} \\%
		\hline
		\hline
		\cellcolor{gray!25}\textbf{reserved} & \cellcolor{gray!25}00    & \cellcolor{gray!25}(0x00)       & \cellcolor{gray!25} & \cellcolor{gray!25}\\%
		\cellcolor{gray!25}\textbf{reserved} & \cellcolor{gray!25}01    & \cellcolor{gray!25}(0x01)       & \cellcolor{gray!25} & \cellcolor{gray!25}\\%
		\textbf{p\_key}                      & 02                       & (0x02)                          & w                   & route packets to peripheral device             \\%
		\textbf{p\_mask}                     & 03                       & (0x03)                          & w                   & route packets to peripheral device             \\%
		\cellcolor{gray!25}\textbf{reserved} & \cellcolor{gray!25}04-11 & \cellcolor{gray!25} (0x04-0x0b) & \cellcolor{gray!25} & \cellcolor{gray!25}\\%
		\textbf{lc\_key}                     & 12                       & (0x0c)                          & w                   & route packets to SpiNNaker FPGA  \\%
		\textbf{lc\_mask}                    & 13                       & (0x0d)                          & w                   & route packets to SpiNNaker FPGA  \\%
		\textbf{rc\_key}                     & 14                       & (0x0e)                          & w                   & route packets to spif configuration   \\%
		\textbf{rc\_mask}                    & 15                       & (0x0f)                          & w                   & route packets to spif configuration   \\%
		\textbf{stop}                        & 16                       & (0x10)                          & w                   & stop peripheral input packets         \\%
		\textbf{start}                       & 17                       & (0x11)                          & w                   & allow peripheral input packets         \\%
		\hline
	\end{tabularx}
\end{center}


\subsection{Register Details}


\begin{center}
	\rowcolors {1}{}{ \tblc }
	%		\renewcommand{\arraystretch}{1.2}
	\begin{tabularx}{\textwidth}{| p{35mm} p{11mm} p{22mm} X |}
		\hline
		\textbf{name} & \textbf{width}  & \textbf{default} & \textbf{comment} \\%
		\hline
		\hline
		\textbf{p\_key}                      & 32b  & \ttfamily{0xffffffff} &  no packets routed to periheral by default \\%
		\textbf{p\_mask}                     & 32b  & \ttfamily{0x00000000} &  no packets routed to periheral by default \\%
		\textbf{lc\_key}                     & 32b  & \ttfamily{0xfffffe00} &  lc\_key and lc\_mask updated atomically  \\%
		\textbf{lc\_mask}                    & 32b  & \ttfamily{0xffffff00} &  write lc\_mask first then lc\_key        \\%
		\textbf{rc\_key}                     & 32b  & \ttfamily{0xffffff00} &  \\%
		\textbf{rc\_mask}                    & 32b  & \ttfamily{0xffffff00} &  \\%
		\textbf{stop}                        &      & stop                  &  access triggers command - data ignored  \\%
		\textbf{start}                       &      & stop                  &  access triggers command - data ignored  \\%
		\hline
	\end{tabularx}
\end{center}


\clearpage


\section{Mapping peripheral inputs to SpiNNaker packets}


\begin{figure}[!ht]
	\centering
	\begin{minipage}{0.70\columnwidth}
		\begin{algorithm}[H]
			\caption{event to SpiNNaker packet mapping pseudocode}
			\begin{algorithmic}[1]
				\For {i in [0 .. 3]}
				\State field[i] = (event \textit{AND} mask[i]) \textit{RIGHT\_SHIFT} shift[i]
				\EndFor
				\State accumulator[0] = map\_key
				\For {i in [1 .. 3]}
				\State accumulator[i] = accumulator[i-1] \textit{OR} field[i]
				\EndFor
				\State packet\_key = accumulator[3]
			\end{algorithmic}
			\label{alg:crd+cfc_fifo}
		\end{algorithm}
	\end{minipage}
\end{figure}


\image[width = 0.9 \textwidth]{!h}{mapper_ex}{fig:maper_fig}
{DVS event to SpiNNaker packet mapping example.}


\begin{table}[!ht]
	\begin{center}
		\begin{tabular}{| l l l l |}
			\hline
			\textbf{register}      & \textbf{field name} & \textbf{value} & \textbf{comment} \\%
			\hline
			\hline
			\textbf{map key}       &                   & 0xeeee0000 & no mask/shift  \\%
			\textbf{field mask 0}  & y coord           & 0x0000007f &                \\%
			\textbf{field mask 1}  & x coord           & 0x007f0000 &                \\%
			\textbf{field mask 2}  & p (polarity)      & 0x00008000 &                \\%
			\textbf{field mask 3}  & \textit{not used} & 0x00000000 & must be 0      \\%
			\textbf{field shift 0} & y coord           & 0          &                \\%
			\textbf{field shift 1} & x coord           & 9          &                \\%
			\textbf{field shift 2} & p (polarity)      & 1          &                \\%
			\textbf{field shift 3} & \textit{not used} & -          & ignored (mask is 0) \\%
			\hline
		\end{tabular}
		\caption{Register configuration for mapping example}
	\end{center}
	\label{tab:map_regs}
\end{table}


\vspace*{1.0cm}
\rule{\linewidth}{2pt}


\subsection*{\itshape Change log:}


\begin{itemize}
	\item {\itshape 1.0.0 - 03jul21 - lap} - initial release - comments to
	{\itshape luis.plana@manchester.ac.uk}
\end{itemize}


\end{document}
